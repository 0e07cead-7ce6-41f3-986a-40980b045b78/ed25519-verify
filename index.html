<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ed25519 ç•™è¨€ç°½åé©—è­‰ï¼ˆå®˜æ–¹å…¬é‘°ï¼‰</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
      line-height: 1.6;
    }

    h2 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }

    .notice {
      background: #f0f8ff;
      padding: 15px;
      border-left: 4px solid #2196F3;
      margin: 15px 0;
      font-size: 14px;
      color: #555;
    }

    .warning {
      background: #fff3cd;
      border-left-color: #ffc107;
    }

    label {
      display: block;
      font-weight: bold;
      margin-top: 15px;
      color: #333;
    }

    textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.3s, background-color 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #4CAF50;
    }

    textarea[readonly] {
      background-color: #f5f5f5;
      cursor: default;
    }

    .hash-match {
      border-color: #4CAF50 !important;
      background-color: #e8f5e9 !important;
    }

    .hash-mismatch {
      border-color: #f44336 !important;
      background-color: #ffebee !important;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-top: 10px;
    }

    button:hover {
      background-color: #45a049;
    }

    button:active {
      transform: scale(0.98);
    }

    #result {
      font-weight: bold;
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      font-size: 16px;
      display: none;
    }

    .result-valid {
      background-color: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
      display: block;
    }

    .result-invalid {
      background-color: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
      display: block;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      word-break: break-all;
    }

    .key-info {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }

    hr {
      border: none;
      border-top: 2px solid #eee;
      margin: 30px 0;
    }

    .example-section {
      background: #f0f8f0;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }

    .example-btn {
      background-color: #2196F3;
      margin-left: 10px;
      padding: 8px 16px;
      font-size: 14px;
    }

    .example-btn:hover {
      background-color: #0b7dda;
    }
  </style>
</head>

<body>
  <h2>Ed25519 ç•™è¨€ç°½åé©—è­‰å·¥å…·</h2>

  <div class="notice">
    <strong>ğŸ“Œ èªªæ˜</strong><br>
    æœ¬é ä½¿ç”¨<strong>å®˜æ–¹å…§åµŒå…¬é‘°</strong>é©—è­‰ç•™è¨€ç°½åã€‚<br>
    ä½¿ç”¨è€…ç„¡éœ€ã€ä¹Ÿç„¡æ³•è‡ªè¡ŒæŒ‡å®šå…¬é‘°ï¼Œç¢ºä¿é©—è­‰å®‰å…¨æ€§ã€‚<br>
    <strong>ğŸ”’ å®‰å…¨æ€§ï¼š</strong>ä½¿ç”¨ Web Crypto APIï¼ˆç€è¦½å™¨åŸç”Ÿæ”¯æ´ï¼‰ã€‚
  </div>

  <div class="notice warning">
    <strong>âš ï¸ é‡è¦æé†’</strong><br>
    â€¢ ç•™è¨€åŸæ–‡å¿…é ˆ<strong>é€å­—ç›¸ç¬¦</strong>ï¼ˆåŒ…æ‹¬æ‰€æœ‰ç©ºæ ¼ã€æ›è¡Œç¬¦è™Ÿï¼‰<br>
    â€¢ ç°½åæ ¼å¼ç‚º<strong>æ¨™æº– Base64</strong>ï¼ˆä½¿ç”¨ + å’Œ / å­—ç¬¦ï¼‰<br>
    â€¢ Ed25519 ç°½åå›ºå®šé•·åº¦ç‚º 64 bytesï¼ˆBase64 ç·¨ç¢¼å¾Œç‚º 88 å­—ç¬¦ï¼‰
  </div>

  <label for="message">ç•™è¨€åŸæ–‡ï¼ˆUTF-8ï¼‰</label>
  <textarea id="message" rows="6" placeholder="è«‹è¼¸å…¥éœ€è¦é©—è­‰çš„ç•™è¨€åŸæ–‡..." oninput="calculateMessageHash()"></textarea>

  <label for="messageHash">ç•™è¨€åŸæ–‡ SHA-256 Hashï¼ˆç”¨æ–¼é©—è­‰è¨Šæ¯å®Œæ•´æ€§ï¼‰</label>
  <textarea id="messageHash" rows="2" readonly placeholder="è¼¸å…¥ç•™è¨€å¾Œå°‡è‡ªå‹•è¨ˆç®— SHA-256..."></textarea>

  <label for="expectedHash">ç•™è¨€åŸæ–‡çš„ SHA-256ï¼ˆè²¼ä¸Šä»¥é€²è¡Œæ¯”å°ï¼‰</label>
  <textarea id="expectedHash" rows="2" placeholder="è²¼ä¸Šé æœŸçš„ SHA-256 é›œæ¹Šå€¼é€²è¡Œæ¯”å°..." oninput="compareHashes()"></textarea>

  <label for="signature">ç°½åï¼ˆBase64 æ ¼å¼ï¼‰</label>
  <textarea id="signature" rows="3" placeholder="è«‹è¼¸å…¥ Base64 æ ¼å¼çš„ç°½å..."></textarea>

  <button onclick="verify()">ğŸ” é©—è­‰ç°½å</button>
  <button class="example-btn" onclick="loadExample()">ğŸ“ è¼‰å…¥æ¸¬è©¦ç¯„ä¾‹</button>

  <div id="result"></div>

  <hr>

  <div class="example-section">
    <strong>ğŸ§ª æ¸¬è©¦ç¯„ä¾‹</strong><br>
    é»æ“Šã€Œè¼‰å…¥æ¸¬è©¦ç¯„ä¾‹ã€æŒ‰éˆ•å¯è‡ªå‹•å¡«å…¥ä»¥ä¸‹å…§å®¹é€²è¡Œæ¸¬è©¦ï¼š<br><br>
    <strong>ç•™è¨€ï¼š</strong><code>Hello, World!</code><br>
    <strong>ç°½åï¼š</strong><code>ï¼ˆéœ€ç”±å®˜æ–¹ç§é‘°ç”Ÿæˆçš„æœ‰æ•ˆç°½åï¼‰</code>
  </div>

  <div class="key-info">
    <strong>ğŸ”‘ å®˜æ–¹å…¬é‘°è³‡è¨Š</strong><br><br>
    <strong>å…¬é‘°ï¼ˆBase64ï¼‰ï¼š</strong><br>
    <code>G1wkVr/RzU/rFKr6pkxz3ZdLoIXCk7LKvjVHzIDA+CM=</code><br><br>
    <strong>å…¬é‘°æŒ‡ç´‹ï¼ˆSHA-256ï¼‰ï¼š</strong><br>
    <code>F0F266E24ABBF0FF33737C83F0DD1E5ED333E92BC1E7DE6186CCC0C562FC14B0</code>
  </div>

  <script>
    const PUBLIC_KEY_B64 = "G1wkVr/RzU/rFKr6pkxz3ZdLoIXCk7LKvjVHzIDA+CM=";

    // Base64 è§£ç¢¼å‡½æ•¸
    function base64ToBytes(base64) {
      const binaryString = atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    // Ed25519 é©—è­‰å‡½æ•¸ï¼ˆä½¿ç”¨ Web Crypto APIï¼‰
    async function verify() {
      console.log("verify() å‡½æ•¸è¢«èª¿ç”¨");
      const resultEl = document.getElementById("result");

      // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ Web Crypto API
      if (!window.crypto || !window.crypto.subtle) {
        console.error("ä¸æ”¯æ´ Web Crypto API");
        showResult("âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Crypto API", false);
        return;
      }

      console.log("Web Crypto API å¯ç”¨");

      try {
        const message = document.getElementById("message").value;
        const signatureB64 = document.getElementById("signature").value.trim();

        // è¼¸å…¥é©—è­‰
        if (!message) {
          showResult("âŒ è«‹è¼¸å…¥ç•™è¨€åŸæ–‡", false);
          return;
        }

        if (!signatureB64) {
          showResult("âŒ è«‹è¼¸å…¥ç°½å", false);
          return;
        }

        // æª¢æŸ¥ Base64 æ ¼å¼
        if (!/^[A-Za-z0-9+/]+=*$/.test(signatureB64)) {
          showResult("âŒ ç°½åæ ¼å¼éŒ¯èª¤ï¼ˆæ‡‰ç‚ºæ¨™æº– Base64 æ ¼å¼ï¼‰", false);
          return;
        }

        // è§£ç¢¼
        let signature, publicKeyBytes;

        try {
          signature = base64ToBytes(signatureB64);
          publicKeyBytes = base64ToBytes(PUBLIC_KEY_B64);
        } catch (e) {
          showResult("âŒ Base64 è§£ç¢¼å¤±æ•—ï¼š" + e.message, false);
          return;
        }

        // æª¢æŸ¥ç°½åé•·åº¦
        if (signature.length !== 64) {
          showResult(
            `âŒ ç°½åé•·åº¦éŒ¯èª¤ï¼ˆEd25519 ç°½åæ‡‰ç‚º 64 bytesï¼Œå¯¦éš›ç‚º ${signature.length} bytesï¼‰`,
            false
          );
          return;
        }

        // æª¢æŸ¥å…¬é‘°é•·åº¦
        if (publicKeyBytes.length !== 32) {
          showResult("âŒ å…¬é‘°é•·åº¦éŒ¯èª¤", false);
          return;
        }

        // å°‡ç•™è¨€è½‰ç‚º Uint8Array
        const messageBytes = new TextEncoder().encode(message);

        // åŒ¯å…¥å…¬é‘°
        const publicKey = await crypto.subtle.importKey(
          "raw",
          publicKeyBytes,
          {
            name: "Ed25519",
          },
          false,
          ["verify"]
        );

        // é©—è­‰ç°½å
        const isValid = await crypto.subtle.verify(
          "Ed25519",
          publicKey,
          signature,
          messageBytes
        );

        if (isValid) {
          showResult("âœ… ç°½åæœ‰æ•ˆï¼ˆVerifiedï¼‰<br>æ­¤ç•™è¨€ç”±å®˜æ–¹ç§é‘°ç°½ç½²ï¼Œç¢ºèªçœŸå¯¦å¯ä¿¡", true);
        } else {
          showResult("âŒ ç°½åç„¡æ•ˆï¼ˆInvalid Signatureï¼‰<br>ç°½åèˆ‡ç•™è¨€å…§å®¹ä¸ç¬¦ï¼Œæˆ–éå®˜æ–¹ç°½ç½²", false);
        }

      } catch (e) {
        console.error("é©—è­‰éŒ¯èª¤ï¼š", e);

        // ç‰¹åˆ¥è™•ç†ä¸æ”¯æ´ Ed25519 çš„æƒ…æ³
        if (e.message && e.message.includes("Ed25519")) {
          showResult("âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Ed25519 ç°½åé©—è­‰<br>è«‹ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Edge æˆ– Firefox", false);
        } else {
          showResult("âŒ é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + (e.message || "æœªçŸ¥éŒ¯èª¤"), false);
        }
      }
    }

    function showResult(message, isValid) {
      console.log("showResult è¢«èª¿ç”¨:", message, isValid);
      const resultEl = document.getElementById("result");
      if (!resultEl) {
        console.error("æ‰¾ä¸åˆ° result å…ƒç´ ");
        return;
      }
      resultEl.innerHTML = message;
      resultEl.className = isValid ? "result-valid" : "result-invalid";
      resultEl.style.display = "block";
    }

    function loadExample() {
      document.getElementById("message").value = "Hello, World!";
      document.getElementById("signature").value = "";
      calculateMessageHash();
      showResult("â„¹ï¸ æ¸¬è©¦ç¯„ä¾‹å·²è¼‰å…¥ï¼Œè«‹è¼¸å…¥æœ‰æ•ˆçš„ç°½åé€²è¡Œé©—è­‰", false);
    }

    // è¨ˆç®—ç•™è¨€çš„ SHA-256 é›œæ¹Šå€¼
    async function calculateMessageHash() {
      const message = document.getElementById("message").value;
      const messageHashEl = document.getElementById("messageHash");

      if (!message) {
        messageHashEl.value = "";
        return;
      }

      try {
        const encoder = new TextEncoder();
        const data = encoder.encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        messageHashEl.value = hashHex.toUpperCase();
        compareHashes();
      } catch (e) {
        console.error("è¨ˆç®—é›œæ¹Šå¤±æ•—:", e);
        messageHashEl.value = "è¨ˆç®—å¤±æ•—";
      }
    }

    // æ¯”å°é›œæ¹Šå€¼
    function compareHashes() {
      const messageHash = document.getElementById("messageHash").value.trim().toUpperCase();
      const expectedHash = document.getElementById("expectedHash").value.trim().toUpperCase();
      const expectedHashEl = document.getElementById("expectedHash");

      // ç§»é™¤æ‰€æœ‰æ¯”å°æ¨£å¼
      expectedHashEl.classList.remove("hash-match", "hash-mismatch");

      if (!expectedHash || !messageHash) {
        return;
      }

      // æ¯”å°é›œæ¹Šå€¼
      if (messageHash === expectedHash) {
        expectedHashEl.classList.add("hash-match");
      } else {
        expectedHashEl.classList.add("hash-mismatch");
      }
    }

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
    window.addEventListener('load', async () => {
      if (!window.crypto || !window.crypto.subtle) {
        showResult("âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Crypto APIï¼Œç„¡æ³•ä½¿ç”¨æ­¤å·¥å…·", false);
      } else {
        console.log("âœ“ Web Crypto API å¯ç”¨");

        // è¨ˆç®—ä¸¦é¡¯ç¤ºé é¢å®Œæ•´æ€§é›œæ¹Š
        await calculatePageIntegrity();
      }
    });

    // è¨ˆç®—é é¢å®Œæ•´æ€§é›œæ¹Šå€¼
    async function calculatePageIntegrity() {
      try {
        const htmlContent = document.documentElement.outerHTML;
        const encoder = new TextEncoder();
        const data = encoder.encode(htmlContent);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        console.log("ğŸ“„ é é¢ SHA-256:", hashHex.toUpperCase());

        // é¡¯ç¤ºåœ¨é é¢ä¸Š
        const integrityDiv = document.createElement('div');
        integrityDiv.style.cssText = 'margin-top: 20px; padding: 10px; background: #e8f5e9; border-left: 4px solid #4caf50; font-size: 12px;';
        integrityDiv.innerHTML = `
      <strong>ğŸ”’ é é¢å®Œæ•´æ€§é©—è­‰</strong><br>
      SHA-256: <code style="font-size: 11px; word-break: break-all;">${hashHex.toUpperCase()}</code><br>
      <small style="color: #666;">æ­¤é›œæ¹Šå€¼å¯ç”¨æ–¼é©—è­‰æª”æ¡ˆæœªè¢«ç«„æ”¹</small>
    `;
        document.body.appendChild(integrityDiv);
      } catch (e) {
        console.error("è¨ˆç®—é é¢é›œæ¹Šå¤±æ•—:", e);
      }
    }
  </script>
</body>


</html>