<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <title>Ed25519 ç•™è¨€ç°½åé©—è­‰(å®˜æ–¹å…¬é‘°)</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 20px;
      line-height: 1.6;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
      margin-top: 0;
    }

    .notice {
      background: #f0f8ff;
      padding: 15px;
      border-left: 4px solid #2196F3;
      margin: 15px 0;
      font-size: 14px;
      color: #555;
      border-radius: 4px;
    }

    .warning {
      background: #fff3cd;
      border-left-color: #ffc107;
    }

    .security-badge {
      background: #e8f5e9;
      border-left-color: #4caf50;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .security-badge::before {
      content: "ğŸ”’";
      font-size: 24px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-top: 15px;
      color: #333;
      font-size: 15px;
    }

    textarea {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.3s, background-color 0.3s, box-shadow 0.3s;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    textarea[readonly] {
      background-color: #f5f5f5;
      cursor: default;
    }

    .hash-match {
      border-color: #4CAF50 !important;
      background-color: #e8f5e9 !important;
    }

    .hash-mismatch {
      border-color: #f44336 !important;
      background-color: #ffebee !important;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      font-weight: 500;
    }

    button:hover {
      background-color: #45a049;
    }

    button:active {
      transform: scale(0.98);
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .example-btn {
      background-color: #2196F3;
    }

    .example-btn:hover {
      background-color: #0b7dda;
    }

    .clear-btn {
      background-color: #757575;
    }

    .clear-btn:hover {
      background-color: #616161;
    }

    #result {
      font-weight: bold;
      margin-top: 20px;
      padding: 20px;
      border-radius: 6px;
      font-size: 16px;
      display: none;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-valid {
      background-color: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
      display: block;
    }

    .result-invalid {
      background-color: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
      display: block;
    }

    .result-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 2px solid #bee5eb;
      display: block;
    }

    code {
      background: #f4f4f4;
      padding: 3px 8px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      word-break: break-all;
    }

    .key-info {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 6px;
      margin: 20px 0;
      border: 1px solid #e0e0e0;
    }

    hr {
      border: none;
      border-top: 2px solid #eee;
      margin: 30px 0;
    }

    .example-section {
      background: #f0f8f0;
      padding: 20px;
      border-radius: 6px;
      margin: 20px 0;
      border: 1px solid #c8e6c9;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-top: 5px;
    }

    .integrity-check {
      margin-top: 20px;
      padding: 15px;
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      font-size: 13px;
      border-radius: 4px;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      color: #2196F3;
      margin-left: 5px;
    }

    .tooltip:hover::after {
      content: attr(data-tip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: #333;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
    }

    .warning-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 20px;
      border-radius: 6px;
      margin: 20px 0;
    }

    .warning-box strong {
      color: #856404;
      font-size: 16px;
    }

    .warning-box ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .warning-box li {
      margin: 8px 0;
      color: #856404;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>ğŸ” Ed25519 ç•™è¨€ç°½åé©—è­‰å·¥å…·</h2>

    <div class="notice security-badge">
      <div>
        <strong>å®‰å…¨é©—è­‰ç³»çµ±</strong><br>
        ä½¿ç”¨ Web Crypto API é€²è¡Œç«¯åˆ°ç«¯åŠ å¯†é©—è­‰<br>
        æ‰€æœ‰é©—è­‰å‡åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬åœ°å®Œæˆï¼Œç„¡æ•¸æ“šä¸Šå‚³
      </div>
    </div>

    <div class="notice">
      <strong>ğŸ“Œ èªªæ˜</strong><br>
      æœ¬é ä½¿ç”¨<strong>å®˜æ–¹å…§åµŒå…¬é‘°</strong>é©—è­‰ç•™è¨€ç°½åã€‚<br>
      ä½¿ç”¨è€…ç„¡éœ€ã€ä¹Ÿç„¡æ³•è‡ªè¡ŒæŒ‡å®šå…¬é‘°,ç¢ºä¿é©—è­‰å®‰å…¨æ€§ã€‚<br>
      <strong>ğŸ”‘ å®‰å…¨æ€§:</strong>ä½¿ç”¨ Web Crypto API(ç€è¦½å™¨åŸç”Ÿæ”¯æŒ)ã€‚
    </div>

    <div class="notice warning">
      <strong>âš ï¸ é‡è¦æé†’</strong><br>
      â€¢ ç•™è¨€åŸæ–‡å¿…é ˆ<strong>é€å­—ç›¸ç¬¦</strong>(åŒ…æ‹¬æ‰€æœ‰ç©ºæ ¼ã€æ›è¡Œç¬¦è™Ÿ)<br>
      â€¢ ç°½åæ ¼å¼ç‚º<strong>æ¨™æº– Base64</strong>(ä½¿ç”¨ + å’Œ / å­—ç¬¦)<br>
      â€¢ Ed25519 ç°½åå›ºå®šé•·åº¦ç‚º 64 bytes(Base64 ç·¨ç¢¼å¾Œç‚º 88 å­—ç¬¦)<br>
      â€¢ æœ¬å·¥å…·å·²é€šé XSS å®‰å…¨å¯©è¨ˆ,ä½¿ç”¨ textContent é˜²è­·
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">ç®—æ³•</div>
        <div class="stat-value">Ed25519</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ç°½åé•·åº¦</div>
        <div class="stat-value">64 Bytes</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å®‰å…¨ç­‰ç´š</div>
        <div class="stat-value">128-bit</div>
      </div>
    </div>

    <label for="message">
      ç•™è¨€åŸæ–‡(UTF-8)
      <span class="tooltip" data-tip="å¿…é ˆèˆ‡ç°½åæ™‚çš„å…§å®¹å®Œå…¨ä¸€è‡´">â„¹ï¸</span>
    </label>
    <textarea id="message" rows="6" placeholder="è«‹è¼¸å…¥éœ€è¦é©—è­‰çš„ç•™è¨€åŸæ–‡..." oninput="calculateMessageHash()"></textarea>

    <div id="newlineWarning" style="display: none;" class="notice warning">
      <strong>âš ï¸ æª¢æ¸¬åˆ°æ›è¡Œç¬¦è™Ÿ</strong><br>
      <span id="newlineType"></span><br>
      é©—è­‰æ™‚å°‡è‡ªå‹•æ¨™æº–åŒ–ç‚º LF (\n) æ ¼å¼
    </div>

    <label for="messageHash">
      ç•™è¨€åŸæ–‡ SHA-256 Hash(ç”¨æ–¼é©—è­‰è¨Šæ¯å®Œæ•´æ€§)
      <span class="tooltip" data-tip="è‡ªå‹•è¨ˆç®—,ç”¨æ–¼ç¢ºèªå…§å®¹æœªè¢«ç¯¡æ”¹">â„¹ï¸</span>
    </label>
    <textarea id="messageHash" rows="2" readonly placeholder="è¼¸å…¥ç•™è¨€å¾Œå°‡è‡ªå‹•è¨ˆç®— SHA-256..."></textarea>

    <label for="expectedHash">
      ç•™è¨€åŸæ–‡çš„ SHA-256(è²¼ä¸Šä»¥é€²è¡Œæ¯”å°)
      <span class="tooltip" data-tip="å¦‚æœæ‚¨æœ‰å®˜æ–¹æä¾›çš„ Hash å€¼,å¯è²¼ä¸Šæ¯”å°">â„¹ï¸</span>
    </label>
    <textarea id="expectedHash" rows="2" placeholder="è²¼ä¸Šé æœŸçš„ SHA-256 é›œæ¹Šå€¼é€²è¡Œæ¯”å°..." oninput="compareHashes()"></textarea>

    <label for="signature">
      ç°½å(Base64 æ ¼å¼)
      <span class="tooltip" data-tip="ç”±å®˜æ–¹ç§é‘°ç”Ÿæˆçš„ Ed25519 ç°½å">â„¹ï¸</span>
    </label>
    <textarea id="signature" rows="3" placeholder="è«‹è¼¸å…¥ Base64 æ ¼å¼çš„ç°½å..." oninput="validateSignatureFormat()"></textarea>

    <div class="button-group">
      <button onclick="verify()">ğŸ” é©—è­‰ç°½å</button>
      <button class="example-btn" onclick="loadExample()">ğŸ“ è¼‰å…¥æ¸¬è©¦ç¯„ä¾‹</button>
      <button class="clear-btn" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ¬„ä½</button>
    </div>

    <div id="result"></div>

    <hr>

    <div class="example-section">
      <strong>ğŸ§ª æ¸¬è©¦ç¯„ä¾‹</strong><br>
      é»æ“Šã€Œè¼‰å…¥æ¸¬è©¦ç¯„ä¾‹ã€æŒ‰éˆ•å¯è‡ªå‹•å¡«å…¥ä»¥ä¸‹å…§å®¹é€²è¡Œæ¸¬è©¦:<br><br>
      <strong>ç•™è¨€:</strong><code>Hello, World!</code><br>
      <strong>ç°½å:</strong><code>(éœ€ç”±å®˜æ–¹ç§é‘°ç”Ÿæˆçš„æœ‰æ•ˆç°½å)</code><br><br>
      <small style="color: #666;">ğŸ’¡ æç¤º: æ¸¬è©¦ç¯„ä¾‹åƒ…ä¾›å­¸ç¿’ä½¿ç”¨,å¯¦éš›é©—è­‰éœ€è¦çœŸå¯¦çš„ç°½åæ•¸æ“š</small>
    </div>

    <div class="key-info">
      <strong>ğŸ”‘ å®˜æ–¹å…¬é‘°è³‡è¨Š</strong><br><br>
      <strong>å…¬é‘°(Base64):</strong><br>
      <code>G1wkVr/RzU/rFKr6pkxz3ZdLoIXCk7LKvjVHzIDA+CM=</code><br><br>
      <strong>å…¬é‘°æŒ‡ç´‹(SHA-256):</strong><br>
      <code>F0F266E24ABBF0FF33737C83F0DD1E5ED333E92BC1E7DE6186CCC0C562FC14B0</code><br><br>
      <strong>ç”¨é€”:</strong>é©—è­‰å®˜æ–¹ç™¼å¸ƒçš„ç•™è¨€ç°½å<br>
      <strong>æ›´æ–°æ—¥æœŸ:</strong>2025å¹´1æœˆ
    </div>

    <div class="warning-box">
      <strong>âš ï¸ é‡è¦å®‰å…¨æé†’ï¼šå¦‚ä½•ç¢ºèªé€™æ˜¯å®˜æ–¹ç‰ˆæœ¬ï¼Ÿ</strong><br><br>
      æœ¬å·¥å…·çš„å®‰å…¨æ€§å®Œå…¨ä¾è³´æ–¼<strong>å…¬é‘°çš„çœŸå¯¦æ€§</strong>ã€‚æ”»æ“Šè€…å¯ä»¥ï¼š
      <ul>
        <li>ä¿®æ”¹æ­¤ HTML æª”æ¡ˆï¼Œæ›¿æ›æˆæ”»æ“Šè€…çš„å…¬é‘°</li>
        <li>ç”¨æ”»æ“Šè€…çš„ç§é‘°ç°½ç½²å‡è¨Šæ¯</li>
        <li>é©—è­‰æœƒé€šéï¼Œä½†å…§å®¹æ˜¯å‡çš„</li>
      </ul>
      <strong>æ­£ç¢ºçš„é©—è­‰æ–¹å¼ï¼š</strong>
      <ul>
        <li>âœ… ç›´æ¥å¾å®˜æ–¹ HTTPS ç¶²ç«™ä½¿ç”¨ï¼ˆä¸è¦ä¸‹è¼‰åˆ°æœ¬åœ°ï¼‰</li>
        <li>âœ… é©—è­‰æ­¤æª”æ¡ˆçš„ SHA-256ï¼ˆå¾å¯ä¿¡æ¸ é“ç²å–å®˜æ–¹ Hashï¼‰</li>
        <li>âœ… å¾å®˜æ–¹ GitHub Repository æª¢è¦–åŸå§‹ç¢¼</li>
        <li>âŒ ä¸è¦å¾ä¸æ˜ä¾†æºä¸‹è¼‰ä¸¦ä¿¡ä»»æ­¤æª”æ¡ˆ</li>
      </ul>
      <strong>æœ¬æª”æ¡ˆçš„å®˜æ–¹ SHA-256ï¼š</strong><br>
      <code style="font-size: 11px;">ï¼ˆæ‡‰ç”±å®˜æ–¹é€éå®‰å…¨æ¸ é“å¦å¤–ç™¼å¸ƒï¼‰</code>
    </div>

  </div>

  <script>
    "use strict";

    const PUBLIC_KEY_B64 = "G1wkVr/RzU/rFKr6pkxz3ZdLoIXCk7LKvjVHzIDA+CM=";

    // å®‰å…¨çš„ Base64 è§£ç¢¼å‡½æ•¸
    function base64ToBytes(base64) {
      try {
        // æ¸…ç†è¼¸å…¥
        const cleaned = base64.trim().replace(/\s/g, '');
        const binaryString = atob(cleaned);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes;
      } catch (e) {
        throw new Error("Base64 è§£ç¢¼å¤±æ•—: æ ¼å¼ä¸æ­£ç¢º");
      }
    }

    // å®‰å…¨çš„éŒ¯èª¤è¨Šæ¯æ¶ˆæ¯’
    function sanitizeErrorMessage(error) {
      if (!error) return "æœªçŸ¥éŒ¯èª¤";

      // åªä¿ç•™å®‰å…¨çš„éŒ¯èª¤è¨Šæ¯
      const safeMessages = {
        'NotSupportedError': 'ç€è¦½å™¨ä¸æ”¯æŒ Ed25519',
        'DataError': 'æ•¸æ“šæ ¼å¼éŒ¯èª¤',
        'OperationError': 'æ“ä½œå¤±æ•—'
      };

      if (error.name && safeMessages[error.name]) {
        return safeMessages[error.name];
      }

      // ç§»é™¤å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯,åªä¿ç•™åŸºæœ¬éŒ¯èª¤é¡å‹
      const message = String(error.message || error);
      if (message.includes('Ed25519')) {
        return 'ä¸æ”¯æŒ Ed25519 ç®—æ³•';
      }
      if (message.includes('key')) {
        return 'å¯†é‘°è™•ç†éŒ¯èª¤';
      }

      return 'é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤';
    }

    // æ¨™æº–åŒ–æ›è¡Œç¬¦è™Ÿ
    function normalizeNewlines(text, target = 'LF') {
      if (target === 'LF') {
        // çµ±ä¸€è½‰æ›ç‚º LF (\n)
        return text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      } else if (target === 'CRLF') {
        // çµ±ä¸€è½‰æ›ç‚º CRLF (\r\n)
        return text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\n/g, '\r\n');
      }
      return text;
    }

    // æª¢æ¸¬æ›è¡Œé¡å‹
    function detectNewlineType(text) {
      if (text.includes('\r\n')) return 'CRLF';
      if (text.includes('\n')) return 'LF';
      if (text.includes('\r')) return 'CR';
      return 'none';
    }

    // Ed25519 é©—è­‰å‡½æ•¸(ä½¿ç”¨ Web Crypto API)
    async function verify() {
      console.log("verify() å‡½æ•¸è¢«èª¿ç”¨");
      const resultEl = document.getElementById("result");

      // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æŒ Web Crypto API
      if (!window.crypto || !window.crypto.subtle) {
        console.error("ä¸æ”¯æŒ Web Crypto API");
        showResult("âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ Web Crypto API", "invalid");
        return;
      }

      console.log("Web Crypto API å¯ç”¨");

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      showResult("é©—è­‰ä¸­,è«‹ç¨å€™...", "info");
      const verifyBtn = event.target;
      verifyBtn.disabled = true;
      verifyBtn.innerHTML = 'ğŸ” é©—è­‰ä¸­<span class="loading"></span>';

      try {
        let message = document.getElementById("message").value;

        // æª¢æ¸¬ä¸¦è­¦å‘Šæ›è¡Œé¡å‹
        const newlineType = detectNewlineType(message);
        console.log("æª¢æ¸¬åˆ°æ›è¡Œé¡å‹:", newlineType);

        // æ¨™æº–åŒ–ç‚º LF (èˆ‡å¤§å¤šæ•¸ç°½åç³»çµ±ä¸€è‡´)
        message = normalizeNewlines(message, 'LF');
        const signatureB64 = document.getElementById("signature").value.trim();

        // è¼¸å…¥é©—è­‰
        if (!message) {
          showResult("âŒ è«‹è¼¸å…¥ç•™è¨€åŸæ–‡", "invalid");
          return;
        }

        if (!signatureB64) {
          showResult("âŒ è«‹è¼¸å…¥ç°½å", "invalid");
          return;
        }

        // æª¢æŸ¥ Base64 æ ¼å¼
        if (!/^[A-Za-z0-9+/]+=*$/.test(signatureB64)) {
          showResult("âŒ ç°½åæ ¼å¼éŒ¯èª¤(æ‡‰ç‚ºæ¨™æº– Base64 æ ¼å¼)", "invalid");
          return;
        }

        // è§£ç¢¼
        let signature, publicKeyBytes;

        try {
          signature = base64ToBytes(signatureB64);
          publicKeyBytes = base64ToBytes(PUBLIC_KEY_B64);
        } catch (e) {
          showResult("âŒ " + sanitizeErrorMessage(e), "invalid");
          return;
        }

        // æª¢æŸ¥ç°½åé•·åº¦
        if (signature.length !== 64) {
          showResult(
            "âŒ ç°½åé•·åº¦éŒ¯èª¤(Ed25519 ç°½åæ‡‰ç‚º 64 bytes,å¯¦éš›ç‚º " + signature.length + " bytes)",
            "invalid"
          );
          return;
        }

        // æª¢æŸ¥å…¬é‘°é•·åº¦
        if (publicKeyBytes.length !== 32) {
          showResult("âŒ å…¬é‘°é•·åº¦éŒ¯èª¤", "invalid");
          return;
        }

        // å°‡ç•™è¨€è½‰ç‚º Uint8Array
        const messageBytes = new TextEncoder().encode(message);

        // åŒ¯å…¥å…¬é‘°
        const publicKey = await crypto.subtle.importKey(
          "raw",
          publicKeyBytes,
          {
            name: "Ed25519",
          },
          false,
          ["verify"]
        );

        // é©—è­‰ç°½å
        const isValid = await crypto.subtle.verify(
          "Ed25519",
          publicKey,
          signature,
          messageBytes
        );

        if (isValid) {
          showResult(
            "âœ… ç°½åæœ‰æ•ˆ(Verified)\næ­¤ç•™è¨€ç”±å®˜æ–¹ç§é‘°ç°½ç½²,ç¢ºèªçœŸå¯¦å¯ä¿¡\n\né©—è­‰æ™‚é–“: " + new Date().toLocaleString('zh-TW'),
            "valid"
          );
        } else {
          showResult(
            "âŒ ç°½åç„¡æ•ˆ(Invalid Signature)\nç°½åèˆ‡ç•™è¨€å…§å®¹ä¸ç¬¦,æˆ–éå®˜æ–¹ç°½ç½²\n\nå¯èƒ½åŸå› :\nâ€¢ ç•™è¨€å…§å®¹è¢«ä¿®æ”¹\nâ€¢ ç°½åä¸æ˜¯ç”±å®˜æ–¹ç§é‘°ç”Ÿæˆ\nâ€¢ ç°½åèˆ‡ç•™è¨€ä¸åŒ¹é…",
            "invalid"
          );
        }

      } catch (e) {
        console.error("é©—è­‰éŒ¯èª¤:", e);

        // ç‰¹åˆ¥è™•ç†ä¸æ”¯æŒ Ed25519 çš„æƒ…æ³
        if (e.message && e.message.includes("Ed25519")) {
          showResult(
            "âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ Ed25519 ç°½åé©—è­‰\nè«‹ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Edge æˆ– Firefox",
            "invalid"
          );
        } else {
          showResult("âŒ " + sanitizeErrorMessage(e), "invalid");
        }
      } finally {
        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = 'ğŸ” é©—è­‰ç°½å';
      }
    }

    // å®‰å…¨çš„çµæœé¡¯ç¤ºå‡½æ•¸ (ä½¿ç”¨ textContent é¿å… XSS)
    function showResult(message, type) {
      console.log("showResult è¢«èª¿ç”¨:", message, type);
      const resultEl = document.getElementById("result");
      if (!resultEl) {
        console.error("æ‰¾ä¸åˆ° result å…ƒç´ ");
        return;
      }

      // æ¸…ç©ºå…§å®¹
      resultEl.textContent = "";

      // å®‰å…¨è™•ç†: å°‡ \n è½‰æ›ç‚º <br>
      const lines = message.split('\n');
      lines.forEach((line, index) => {
        const textNode = document.createTextNode(line);
        resultEl.appendChild(textNode);

        // åœ¨éæœ€å¾Œä¸€è¡Œæ·»åŠ æ›è¡Œ
        if (index < lines.length - 1) {
          resultEl.appendChild(document.createElement('br'));
        }
      });

      // è¨­ç½®æ¨£å¼é¡åˆ¥
      resultEl.className = type === "valid" ? "result-valid" :
        type === "info" ? "result-info" : "result-invalid";
      resultEl.style.display = "block";
    }

    // è¼‰å…¥æ¸¬è©¦ç¯„ä¾‹
    function loadExample() {
      document.getElementById("message").value = "Hello, World!";
      document.getElementById("signature").value = "";
      document.getElementById("expectedHash").value = "";
      calculateMessageHash();
      showResult("â„¹ï¸ æ¸¬è©¦ç¯„ä¾‹å·²è¼‰å…¥\nè«‹è¼¸å…¥æœ‰æ•ˆçš„ç°½åé€²è¡Œé©—è­‰\n\næç¤º: é€™æ˜¯ä¸€å€‹æ¼”ç¤ºç¯„ä¾‹,éœ€è¦çœŸå¯¦çš„ Ed25519 ç°½åæ‰èƒ½é©—è­‰æˆåŠŸ", "info");
    }

    // æ¸…ç©ºæ‰€æœ‰æ¬„ä½
    function clearAll() {
      document.getElementById("message").value = "";
      document.getElementById("signature").value = "";
      document.getElementById("expectedHash").value = "";
      document.getElementById("messageHash").value = "";
      document.getElementById("result").style.display = "none";

      // ç§»é™¤æ¯”å°æ¨£å¼
      document.getElementById("expectedHash").classList.remove("hash-match", "hash-mismatch");
    }

    // è¨ˆç®—ç•™è¨€çš„ SHA-256 é›œæ¹Šå€¼
    async function calculateMessageHash() {
      const message = document.getElementById("message").value;
      const messageHashEl = document.getElementById("messageHash");

      if (!message) {
        messageHashEl.value = "";
        document.getElementById("newlineWarning").style.display = "none";
        return;
      }

      // æª¢æ¸¬æ›è¡Œé¡å‹ä¸¦é¡¯ç¤ºè­¦å‘Š
      const newlineType = detectNewlineType(message);
      const warningEl = document.getElementById("newlineWarning");
      const typeEl = document.getElementById("newlineType");

      if (newlineType !== 'none') {
        warningEl.style.display = "block";
        const typeNames = {
          'CRLF': 'CRLF (\\r\\n) - Windows é¢¨æ ¼æ›è¡Œ',
          'LF': 'LF (\\n) - Unix/Linux/macOS é¢¨æ ¼æ›è¡Œ',
          'CR': 'CR (\\r) - èˆŠ Mac é¢¨æ ¼æ›è¡Œ'
        };
        typeEl.textContent = `æª¢æ¸¬åˆ°: ${typeNames[newlineType]}`;
      } else {
        warningEl.style.display = "none";
      }

      try {
        // æ¨™æº–åŒ–å¾Œè¨ˆç®— Hash
        const normalizedMessage = normalizeNewlines(message, 'LF');
        const encoder = new TextEncoder();
        const data = encoder.encode(normalizedMessage);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        messageHashEl.value = hashHex.toUpperCase();
        compareHashes();
      } catch (e) {
        console.error("è¨ˆç®—é›œæ¹Šå¤±æ•—:", e);
        messageHashEl.value = "è¨ˆç®—å¤±æ•—";
      }
    }

    // æ¯”å°é›œæ¹Šå€¼
    function compareHashes() {
      const messageHash = document.getElementById("messageHash").value.trim().toUpperCase();
      const expectedHash = document.getElementById("expectedHash").value.trim().toUpperCase();
      const expectedHashEl = document.getElementById("expectedHash");

      // ç§»é™¤æ‰€æœ‰æ¯”å°æ¨£å¼
      expectedHashEl.classList.remove("hash-match", "hash-mismatch");

      if (!expectedHash || !messageHash) {
        return;
      }

      // æ¯”å°é›œæ¹Šå€¼
      if (messageHash === expectedHash) {
        expectedHashEl.classList.add("hash-match");
      } else {
        expectedHashEl.classList.add("hash-mismatch");
      }
    }

    // å³æ™‚é©—è­‰ç°½åæ ¼å¼
    function validateSignatureFormat() {
      const signatureB64 = document.getElementById("signature").value.trim();
      const signatureEl = document.getElementById("signature");

      if (!signatureB64) {
        signatureEl.style.borderColor = "#ddd";
        return;
      }

      // æª¢æŸ¥ Base64 æ ¼å¼
      if (!/^[A-Za-z0-9+/]+=*$/.test(signatureB64)) {
        signatureEl.style.borderColor = "#f44336";
        return;
      }

      // æª¢æŸ¥é•·åº¦
      try {
        const decoded = base64ToBytes(signatureB64);
        if (decoded.length === 64) {
          signatureEl.style.borderColor = "#4CAF50";
        } else {
          signatureEl.style.borderColor = "#ffc107";
        }
      } catch (e) {
        signatureEl.style.borderColor = "#f44336";
      }
    }

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç€è¦½å™¨æ”¯æŒ
    window.addEventListener('load', async () => {
      if (!window.crypto || !window.crypto.subtle) {
        showResult(
          "âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ Web Crypto API,ç„¡æ³•ä½¿ç”¨æ­¤å·¥å…·\nè«‹ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Firefox æˆ– Edge",
          "invalid"
        );
      } else {
        console.log("âœ“ Web Crypto API å¯ç”¨");
      }
    });
  </script>
</body>

</html>